<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #222223 0%, #000000 100%);
            min-height: 100vh;
            padding-bottom: 30px;
        }

        .header {
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 26px;
            margin-bottom: 5px;
        }

        .header h3 {
            color: #d1ea2d;
            font-size: 26px;
            margin-bottom: 5px;
        }

        .header p {
            color: #929191;
            font-size: 14px;
        }


        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #667eea;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* Employee Checkbox List - Green for Present, Red for Absent */
        .employee-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .employee-item:hover {
            background: #f3f4f6;
        }

        .employee-item.present {
            background: #d1fae5;
            border: 2px solid #10b981;
        }

        .employee-item.absent {
            background: #fee2e2;
            border: 2px solid #ef4444;
        }

        .checkbox-wrapper {
            width: 30px;
            height: 30px;
            min-width: 30px;
            border: 3px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            background: white;
            transition: all 0.3s;
        }

        .employee-item.present .checkbox-wrapper {
            background: #10b981;
            border-color: #10b981;
        }

        .employee-item.absent .checkbox-wrapper {
            background: #ef4444;
            border-color: #ef4444;
        }

        .checkmark {
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .employee-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-badge.present {
            background: #10b981;
            color: white;
        }

        .status-badge.absent {
            background: #ef4444;
            color: white;
        }

        /* Bottle Entry - Similar to Employee */
        .bottle-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fef3c7;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #f59e0b;
        }

        .bottle-icon {
            width: 30px;
            height: 30px;
            min-width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .bottle-name {
            font-size: 18px;
            font-weight: 600;
            color: #92400e;
            flex: 1;
        }

        .bottle-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bottle-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bottle-btn:active {
            transform: scale(0.95);
        }

        .bottle-btn.minus {
            background: #ef4444;
            color: white;
        }

        .bottle-btn.plus {
            background: #10b981;
            color: white;
        }

        .bottle-count {
            font-size: 24px;
            font-weight: bold;
            color: #92400e;
            min-width: 40px;
            text-align: center;
        }

        /* Add Uppad Button */
        .add-uppad-btn {
            width: 100%;
            padding: 15px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .add-uppad-btn:hover {
            background: #d97706;
        }

        /* Uppad Form */
        .uppad-form {
            background: #fef3c7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #f59e0b;
        }

        .uppad-form-title {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-select,
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .uppad-list {
            margin-top: 10px;
        }

        .uppad-entry {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e7eb;
        }

        .uppad-entry-name {
            font-weight: 600;
            color: #333;
        }

        .uppad-entry-amount {
            color: #ef4444;
            font-weight: 700;
            font-size: 16px;
        }

        .remove-uppad {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
            transition: all 0.3s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .hidden {
            display: none;
        }

        .loader {
            width: 100%;
            height: 22px;
            border-radius: 40px;
            color: #0b0b0b;
            border: 2px solid;
            position: relative;
        }

        .loader::before {
            content: "";
            position: absolute;
            margin: 2px;
            width: 25%;
            top: 0;
            bottom: 0;
            left: 0;
            border-radius: inherit;
            background: currentColor;
            animation: l3 1s infinite linear;
        }

        @keyframes l3 {
            50% {
                left: 100%;
                transform: translateX(calc(-100% - 4px))
            }
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-top: 15px;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-top: 15px;
        }

        @media (max-width: 480px) {

            .header h1,
            .header h3 {
                font-size: 22px;
            }

        }
    </style>
    <!-- //For authentication -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>


</head>

<body>

    <div id="loginBox" style="text-align:center;margin-top:60px;">
        <h2>üîê Login Required</h2>
        <button onclick="googleLogin()" style="padding:12px 20px;font-size:16px;">
            Sign in with Google
        </button>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <h1>üè¢ MOTABHAI CLOTHING ATTENDANCE SYSTEM</h1>
            <h3>Vadodara-Branch</h3>
            <p>Daily Tracker - attendance & Uppad</p>
        </div>


        <div class="container">
            <div class="card">
                <!-- Date Selection -->
                <div class="section-title">üìÖ Select Date</div>
                <input type="date" id="dateInput" class="date-input">

                <!-- Employee Attendance -->
                <div class="section-title" style="margin-top: 25px;">üë• Employee Attendance</div>
                <div id="employeeList">
                    <!-- Employees will be loaded here -->
                </div>

                <!-- Bottle Entry (Like an Employee) -->
                <div class="section-title" style="margin-top: 25px;">üçæ Bottles</div>
                <div class="bottle-item">
                    <div class="bottle-icon">üçæ</div>
                    <div class="bottle-name">Bottle Order</div>
                    <div class="bottle-controls">
                        <button class="bottle-btn minus" onclick="updateBottles(-1)">‚àí</button>
                        <div class="bottle-count" id="bottleCount">0</div>
                        <button class="bottle-btn plus" onclick="updateBottles(1)">+</button>
                    </div>
                </div>

                <!-- Add Uppad Button -->
                <button class="add-uppad-btn" onclick="toggleUppadForm()">
                    üí∞ + Add Uppad (Advance)
                </button>

                <!-- Uppad Form (Hidden by default) -->
                <div id="uppadFormSection" class="uppad-form hidden">
                    <div class="uppad-form-title">Add Advance/Uppad</div>

                    <div class="form-group">
                        <label>Employee Name:</label>
                        <select id="uppadEmployee" class="form-select">
                            <option value="">-- Select Employee --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount (‚Çπ):</label>
                        <input type="number" id="uppadAmount" class="form-input" placeholder="Enter amount">
                    </div>

                    <button class="submit-btn" style="background: #f59e0b; margin-top: 10px;"
                        onclick="addUppadToList()">
                        ‚úì Add to List
                    </button>

                    <!-- Uppad List -->
                    <div id="uppadListContainer" class="hidden">
                        <div class="uppad-form-title" style="margin-top: 20px;">Today's Uppad:</div>
                        <div id="uppadList" class="uppad-list"></div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button id="mainSubmitBtn" class="submit-btn" onclick="submitData()">‚úì SUBMIT</button>


                <br>
                <!-- Loader -->
                <div id="loader" class="loader hidden"></div>


                <!-- Success/Error Messages -->
                <div id="messageContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiHUtJazOX_7I3aP9w79Ok-LZ3OgjMYQokbkZc3YcfqGsXGgc1eftUomggTNjrHY7g-Q/exec';

        let employees = [];
        let currentDate = new Date().toISOString().split('T')[0];
        let attendance = {}; // Will store: { "Dhanvil": "present", "Rahul": "absent" }
        let bottleCount = 0;
        let uppadData = {}; // Will store: { "Dhanvil": 500, "Rahul": 0 }

        // Initialize on page load
        window.onload = function () {
            document.getElementById('dateInput').value = currentDate;
            loadEmployees();
        };

        // Update date when changed
        document.getElementById('dateInput').addEventListener('change', function () {
            currentDate = this.value;
            resetForm();
        });

        // Load employees from Google Sheets
        async function loadEmployees() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getEmployees`);
                const data = await response.json();

                // Skip header row and load employees
                employees = data
                    .slice(1)
                    .filter(row => row[0] && row[0].toLowerCase() !== 'bottle')
                    .map(row => ({
                        name: row[0],
                        salary: row[1]
                    }));


                // Initialize attendance as null for all
                employees.forEach(emp => {
                    attendance[emp.name] = null; // null = not marked yet
                    uppadData[emp.name] = 0;
                });

                renderEmployeeList();
                populateUppadDropdown();
            } catch (error) {
                console.error('Error loading employees:', error);
                // Fallback to demo data
                employees = [
                    { name: 'Dhanvil', salary: 11000 },
                    { name: 'Pratik', salary: 9500 },
                    { name: 'Rahul', salary: 9000 }
                ];
                employees.forEach(emp => {
                    attendance[emp.name] = null;
                    uppadData[emp.name] = 0;
                });
                renderEmployeeList();
                populateUppadDropdown();
            }
        }

        // Render employee checkboxes with 3 states: unmarked, present (green), absent (red)
        function renderEmployeeList() {
            const container = document.getElementById('employeeList');
            container.innerHTML = '';

            employees.forEach(emp => {
                const status = attendance[emp.name];
                let itemClass = 'employee-item';
                let statusText = '';
                let checkmark = '';

                if (status === 'present') {
                    itemClass += ' present';
                    statusText = 'Present (Tap for ¬Ω)';
                    checkmark = '‚úì';
                }
                else if (status === 'half-day') {
                    itemClass += ' present';
                    statusText = 'Present (Half-Day) ‚Ä¢ Tap to uncheck';
                    checkmark = '¬Ω';
                }

                const div = document.createElement('div');
                div.className = itemClass;

                // ‚úÖ ONE CLICK HANDLES EVERYTHING
                div.onclick = () => toggleAttendance(emp.name);

                div.innerHTML = `
            <div class="checkbox-wrapper">
                <span class="checkmark">${checkmark}</span>
            </div>
            <div class="employee-name">${emp.name}</div>
            ${status ? `<span class="status-badge present">${statusText}</span>` : ''}
        `;

                container.appendChild(div);
            });
        }





        function toggleAttendance(name) {
            if (attendance[name] === null) {
                attendance[name] = 'present';
            }
            else if (attendance[name] === 'present') {
                attendance[name] = 'half-day';
            }
            else {
                attendance[name] = null; // uncheck ‚Üí Absent
            }
            renderEmployeeList();
        }


        // Update bottle count
        function updateBottles(change) {
            bottleCount = Math.max(0, bottleCount + change);
            document.getElementById('bottleCount').textContent = bottleCount;
        }

        // Populate uppad dropdown
        function populateUppadDropdown() {
            const select = document.getElementById('uppadEmployee');
            select.innerHTML = '<option value="">-- Select Employee --</option>';
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }

        // Toggle uppad form visibility
        function toggleUppadForm() {
            const form = document.getElementById('uppadFormSection');
            form.classList.toggle('hidden');
        }

        // Add uppad to data
        function addUppadToList() {
            const empName = document.getElementById('uppadEmployee').value;
            const amount = document.getElementById('uppadAmount').value;

            if (!empName || !amount) {
                showMessage('Please select employee and enter amount!', 'error');
                return;
            }

            // Add to existing uppad
            uppadData[empName] = (uppadData[empName] || 0) + parseFloat(amount);

            // Clear inputs
            document.getElementById('uppadEmployee').value = '';
            document.getElementById('uppadAmount').value = '';

            renderUppadList();
        }

        // Render uppad list
        function renderUppadList() {
            const container = document.getElementById('uppadList');
            const listContainer = document.getElementById('uppadListContainer');

            // Filter employees with uppad > 0
            const employeesWithUppad = employees.filter(emp => uppadData[emp.name] > 0);

            if (employeesWithUppad.length === 0) {
                listContainer.classList.add('hidden');
                return;
            }

            listContainer.classList.remove('hidden');
            container.innerHTML = '';

            employeesWithUppad.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'uppad-entry';
                div.innerHTML = `
                    <span class="uppad-entry-name">${emp.name}</span>
                    <div>
                        <span class="uppad-entry-amount">‚Çπ${uppadData[emp.name]}</span>
                        <button class="remove-uppad" onclick="removeUppad('${emp.name}')">‚úï</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Remove uppad
        function removeUppad(empName) {
            uppadData[empName] = 0;
            renderUppadList();
        }

        // Submit all data to Google Sheets
        async function submitData() {
            const submitBtn = document.getElementById('mainSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            document.getElementById('loader').classList.remove('hidden');


            try {
                // Build rows for each employee
                const rows = employees.map(emp => {
                    return {
                        date: currentDate,
                        employee: emp.name,
                        status:
                            attendance[emp.name] === 'present'
                                ? 'Present'
                                : attendance[emp.name] === 'half-day'
                                    ? 'Present (Half-Day)'
                                    : 'Absent',


                        bottles: 0, // Each employee has 0 bottles
                        uppad: uppadData[emp.name] || 0
                    };
                });

                // Add bottle as separate row
                rows.push({
                    date: currentDate,
                    employee: 'Bottle',
                    status: '-',
                    bottles: bottleCount,
                    uppad: 0
                });

                const dataToSubmit = {
                    action: 'submitDailyData',
                    rows: rows
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    //mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(dataToSubmit)
                });

                const result = await response.json();

                if (result.success === false) {
                    showMessage("‚ö† Already submitted for this date", "error");
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Already Submitted";
                    document.getElementById('loader').classList.add('hidden');
                    return; // ‚õî YAHIN FUNCTION STOP
                }


                showMessage('‚úì Data Submitted Successfully!', 'success');
                submitBtn.disabled = true;
                submitBtn.textContent = "Already Submitted";

                // üî• CLEAR UPPAD UI
                uppadData = {};
                document.getElementById('uppadEmployee').value = '';
                document.getElementById('uppadAmount').value = '';
                document.getElementById('uppadListContainer').classList.add('hidden');
                document.getElementById('uppadList').innerHTML = '';


                // Reset after 2 seconds
                // setTimeout(() => {
                //     resetForm();
                // }, 2000);

            } catch (error) {
                console.error('Error submitting data:', error);
                showMessage('‚úì Data sent to Google Sheets!', 'success');
                setTimeout(() => {
                    resetForm();
                }, 2000);
            } finally {
                // submitBtn.disabled = false;
                // submitBtn.textContent = '‚úì SUBMIT ALL DATA';
                document.getElementById('loader').classList.add('hidden');

            }
        }

        // Reset form after submission
        function resetForm() {
            employees.forEach(emp => {
                attendance[emp.name] = null;
                uppadData[emp.name] = 0;
            });

            bottleCount = 0;
            document.getElementById('bottleCount').textContent = '0';

            document.getElementById('uppadEmployee').value = '';
            document.getElementById('uppadAmount').value = '';
            document.getElementById('uppadListContainer').classList.add('hidden');
            document.getElementById('uppadList').innerHTML = '';

            // ‚úÖ RESET SUBMIT BUTTON (MOST IMPORTANT)
            const submitBtn = document.getElementById('mainSubmitBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úì SUBMIT';

            renderEmployeeList();
        }


        // Show success/error message
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Authentication Google 

        const ALLOWED_EMAILS = [
            "vishwagami111@gmail.com",
            "vishwapatel660@gmail.com",
            "gyash5750@gmail.com",
            "mehulbhutka9999@gmail.com"
        ];

        // Auto login check
        window.addEventListener("load", () => {
            const savedEmail = localStorage.getItem("authEmail");
            if (ALLOWED_EMAILS.includes(savedEmail)) {
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("app").style.display = "block";
            }
        });

        function googleLogin() {
            google.accounts.id.initialize({
                client_id: "70801928772-s5pr9crte2asuqicojimdtpr324rnpml.apps.googleusercontent.com",
                callback: handleLogin
            });

            google.accounts.id.prompt();
        }

        function handleLogin(response) {
            const payload = JSON.parse(atob(response.credential.split(".")[1]));
            const email = payload.email;

            if (ALLOWED_EMAILS.includes(email)) {
                localStorage.setItem("authEmail", email);
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("app").style.display = "block";
            } else {
                alert("‚ùå Access Denied");
            }
        }


    </script>
</body>

</html>